- name: Configure app_java_home in nexus.rc file
  lineinfile:
    path: "{{ nexus_installation_dir }}/bin/nexus.rc"
    regexp: '^#?app_java_home='
    line: 'app_java_home="/usr/lib/jvm/java-17-openjdk"'  # Replace with your actual OpenJDK path
  become: yes
  register: rc_updated

- name: Ensure systemd override directory exists
  file:
    path: "/etc/systemd/system/nexus.service.d"
    state: directory
  become: yes

- name: Set APP_JAVA_HOME in systemd service environment
  blockinfile:
    path: "/etc/systemd/system/nexus.service.d/override.conf"
    create: yes
    block: |
      [Service]
      Environment="APP_JAVA_HOME=/usr/lib/jvm/java-17-openjdk"
  become: yes
  register: service_updated

- name: Stop Nexus service before removing JDK directory
  systemd:
    name: nexus
    state: stopped
  become: yes

- name: Remove bundled JDK directory
  file:
    path: "{{ nexus_installation_dir }}/jdk/termiun/jdk_17"
    state: absent
  become: yes
  register: jdk_removal

- name: Debug JDK removal status
  debug:
    msg: "JDK directory removal: {{ 'Failed' if jdk_removal.failed else 'Successful' }}"

- name: Reload systemd and start nexus
  systemd:
    daemon_reload: yes
    name: nexus
    state: started
  become: yes

- name: Wait for Nexus to start properly
  pause:
    seconds: 30

- name: Check which Java executable Nexus is using
  shell: ps -ef | grep java | grep nexus | grep -v grep
  register: nexus_process
  changed_when: false
  become: yes

- name: Display Nexus Java process information
  debug:
    var: nexus_process.stdout_lines
